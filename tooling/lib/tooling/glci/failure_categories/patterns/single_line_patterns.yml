# patterns.yml
- pattern: "If needed, you can retry the.+`danger-review` job"
  failure_category: "danger"

# Database - DB migrations
- pattern: "Error: rollback of added migrations does not revert db/structure.sql to previous state, please investigate"
  failure_category: "db_migrations"
- pattern: "the committed db/structure.sql does not match the one generated by running added migrations"
  failure_category: "db_migrations"
- pattern: "the committed files in db/schema_migrations do not match those expected by the added migrations"
  failure_category: "db_migrations"
- pattern: "You have.+pending migrations"
  failure_category: "db_migrations"
- pattern: "Column operations, like dropping, renaming or primary key conversion"
  failure_category: "db_migrations"
- pattern: "createdb: error:"
  failure_category: "db_migrations"
- pattern: "Batched migration should be finalized only after at-least one required stop from queuing it"
  failure_category: "db_migrations"
- pattern: "Table.+is write protected within this Gitlab database"
  failure_category: "db_table_write_protected"
- pattern: "Unsupported cross-join across"
  failure_category: "db_table_write_protected"
- pattern: "Gitlab::Database::QueryAnalyzers::GitlabSchemasValidateConnection::CrossSchemaAccessError"
  failure_category: "db_cross_schema_access"
- pattern: "raise_database_connection_made_error"
  failure_category: "db_connection_in_rails_initializer"
- pattern: "Any new or deleted tables must be added to the database dictionary"
  failure_category: "rails_pg_not_in_database_dictionary"
- pattern: "has no foreign key for"
  failure_category: "rails_pg_no_foreign_key"
- pattern: "PG::ActiveSqlTransaction"
  failure_category: "rails_pg_active_sql_transaction"
- pattern: "PG::CheckViolation"
  failure_category: "rails_pg_check_violation"
- pattern: "PG::DependentObjectsStillExist"
  failure_category: "rails_pg_dependent_objects_still_exist"
- pattern: "PG::DuplicateAlias"
  failure_category: "rails_pg_duplicate_alias"
- pattern: "PG::DuplicateTable"
  failure_category: "rails_pg_duplicate_table"
- pattern: "PG::InvalidColumnReference"
  failure_category: "rails_pg_invalid_column_reference"
- pattern: "PG::UndefinedColumn"
  failure_category: "rails_pg_undefined_column"
- pattern: "PG::UndefinedTable"
  failure_category: "rails_pg_undefined_table"
- pattern: "Gitlab::SidekiqSharding::Validator::UnroutedSidekiqApiError"
  failure_category: "rails_pg_sidekiq"
- pattern: "psql:.+ERROR:"
  failure_category: "psql_failed_command"
- pattern: "Gitlab::Database::QueryAnalyzers::RestrictAllowedSchemas::DMLAccessDeniedError:"
  failure_category: "rake_unallowed_schemas_accessed"
- pattern: "Sidekiq::Job::EnqueueFromTransactionError"
  failure_category: "rake_enqueue_from_transaction"
- pattern: "Gitlab::Database::GitlabSchema::UnknownSchemaError"
  failure_category: "rake_db_unknown_schema"
- pattern: "ActiveRecord::UnknownPrimaryKey"
  failure_category: "rake_rails_unknown_primary_key"

# Catch-alls for database-related errors
- pattern: "An error has occurred, this and all later migrations canceled"
  failure_category: "error_in_db_migration"
- pattern: "An error has occurred, all later migrations canceled"
  failure_category: "error_in_db_migration"
- pattern: "ActiveRecord::StatementInvalid"
  failure_category: "rails_invalid_sql_statement"

# Linting
- pattern: "needs to be regenerated, please run:"
  failure_category: "graphql_lint"
- pattern: "GraphQL quer.+out of.+failed validation:"
  failure_category: "graphql_lint"
- pattern: "node scripts/frontend/eslint.js . --format gitlab"
  failure_category: "eslint"
- pattern: "Running ESLint with the following rules enabled"
  failure_category: "eslint"
- pattern: "ERROR: lint test\\(s\\) failed.+Review the log carefully to see full listing"
  failure_category: "docs_lint_failed"
- pattern: "files inspected,.+lints? detected"
  failure_category: "docs_lint_failed"
- pattern: "Issues found in .+input.+Find details below."
  failure_category: "docs_lint_failed"
- pattern: "scripts/lint-docs-redirects.rb"
  failure_category: "docs_lint_failed"
- pattern: "git diff --exit-code db/docs"
  failure_category: "docs_lint_failed"
- pattern: "documentation is outdated.+Please update it by running"
  failure_category: "docs_outdated"
- pattern: "scripts/cells/ci-ensure-application-settings-have-definition-file.rb"
  failure_category: "cells_lint"
- pattern: "blocking Pajamas violation\\(s\\) found."
  failure_category: "pajamas_violations"
- pattern: "Merge request scan exit status: 2"
  failure_category: "pajamas_violations"
- pattern: "yamllint "
  failure_category: "yaml_lint_failed"
- pattern: "Not all PO-files are valid"
  failure_category: "rake_some_po_files_invalid"
- pattern: "Changes in translated strings found, please update file"
  failure_category: "rake_outdated_translated_strings"
- pattern: "ERROR: Deprecations documentation is outdated"
  failure_category: "docs_deprecations_outdated"

# Dependencies (Bundler, Yarn, ...)
- pattern: "Found problems with the lockfile"
  failure_category: "frontend_lockfile"
- pattern: "Your lockfile needs to be updated, but yarn was run with"
  failure_category: "frontend_lockfile"
- pattern: "Peer dependency violation"
  failure_category: "yarn_dependency_violation"
- pattern: "yarn run.+failed with the following error"
  failure_category: "yarn_run"
- pattern: "changed, but the lockfile can't be updated"
  failure_category: "gemfile_issues"
- pattern: "Your lockfile does not satisfy dependencies of"
  failure_category: "gemfile_issues"
- pattern: "contains outdated dependencies"
  failure_category: "gemfile_issues"
- pattern: "You have already activated"
  failure_category: "gemfile_issues"
- pattern: "but your Gemfile requires"
  failure_category: "gemfile_issues"
- pattern: "\\(r-\\)generate Gemfile.checksum with"
  failure_category: "gemfile_issues"
- pattern: "Bundler cannot continue installing"
  failure_category: "gemfile_issues"
- pattern: "Cached checksum for .+ not found"
  failure_category: "gemfile_issues"
- pattern: "Bundler::GemNotFound"
  failure_category: "gems_not_found"
- pattern: "Gem::Ext::BuildError: ERROR: Failed to build gem native extension."
  failure_category: "gems_build"
- pattern: "ERROR: Checksum mismatch for `bao-linux-amd64`"
  failure_category: "bao_linux_checksum_mismatch"
- pattern: "running /usr/local/bin/pipenv sync .+: exit status 1"
  failure_category: "gemnasium-python-dependency_scanning"
- pattern: "\\[gemnasium-python\\] .+ pipenv sync failed"
  failure_category: "gemnasium-python-dependency_scanning"
- pattern: "\\[FATA\\] \\[dependency-scanning\\].+ permission denied"
  failure_category: "dependency-scanning_permission_denied"
- pattern: "Error calling /monitor/project/"
  failure_category: "package_hunter"

# Git
- pattern: "cloning repository: exit status 128"
  failure_category: "git_issues"
- pattern: "did not match any file\\(s\\) known to git"
  failure_category: "git_issues"
- pattern: "failed to push some refs to 'https://gitlab.com/gitlab-org/gitlab-foss.git'"
  failure_category: "as_if_foss_git_push_issues"
- pattern: "fatal: couldn't find remote ref"
  failure_category: "git_issues"
- pattern: "fatal: expected flush after ref listing"
  failure_category: "git_issues"
- pattern: "fatal: fetch-pack: invalid index-pack output"
  failure_category: "git_issues"
- pattern: "fatal: Not a valid object name"
  failure_category: "git_issues"
- pattern: "fatal: protocol error: bad pack header"
  failure_category: "git_issues"
- pattern: "fatal: the remote end hung up unexpectedly"
  failure_category: "git_issues"
- pattern: "TimeoutExpired: Command '\\['git', 'fetch'"
  failure_category: "git_issues"

# Rubocop
- pattern: "offenses? detected"
  failure_category: "rubocop"
- pattern: "=== Filtered warnings ==="
  failure_category: "rubocop"

# Jest
- pattern: "Command .+ node_modules/.bin/jest.+ exited with status 1"
  failure_category: "jest"

# Undercover
- pattern: "some methods have no test coverage!"
  failure_category: "rspec_undercoverage"

# Gitaly
- pattern: "gitaly spawn failed"
  failure_category: "gitaly_spawn_failed"

# Apollo
- pattern: "Loading Apollo Project"
  failure_category: "apollo"

# RSpec tests that already failed on default branch
- pattern: "ERROR: Job failed: exit code 112"
  failure_category: "rspec_test_already_failed_on_default_branch"

# Assets Compilation
- pattern: "Error: Unable to compile webpack production bundle"
  failure_category: "assets_compilation"
- pattern: "webpack-cli.+Error: EEXIST: file already exists"
  failure_category: "webpack_cli"

# VueJS 3
- pattern: "Expected unset environment variable"
  failure_category: "vuejs3"
- pattern: "either now pass under Vue 3, or no longer exist"
  failure_category: "vuejs3"

# RSpec usage
- pattern: "The use of doubles or partial doubles from rspec-mocks outside of the per-test lifecycle is not supported."
  failure_category: "rspec_usage"
- pattern: "Could not find shared context"
  failure_category: "rspec_usage"
- pattern: "Could not find shared examples"
  failure_category: "rspec_usage"
- pattern: "is not available on an example group"
  failure_category: "rspec_usage"
- pattern: "WebMock::NetConnectNotAllowedError"
  failure_category: "rspec_usage"

# Infrastructure issues
- pattern: "GitLab is currently unable to handle this request due to load."
  failure_category: "gitlab_too_much_load"
- pattern: "ERROR: Job failed: failed to pull image"
  failure_category: "failed_to_pull_image"
- pattern: "Is the docker daemon running"
  failure_category: "docker_not_running"
- pattern: "no space left on device"
  failure_category: "no_space_left"
- pattern: "There was insufficient space remaining on the device"
  failure_category: "no_space_left"
- pattern: "Uploading artifacts .+ 502 Bad Gateway"
  failure_category: "artifacts_upload_502"
- pattern: "500 Internal Server Error"
  failure_category: "http_500"
- pattern: "Error: Kubernetes cluster unreachable"
  failure_category: "kubernetes"
- pattern: "502 Server Error"
  failure_category: "http_502"
- pattern: "502 \"Bad Gateway\""
  failure_category: "http_502"
- pattern: "status code: 502"
  failure_category: "http_502"
- pattern: "The requested URL returned error: 500"
  failure_category: "gitlab_unavailable"
- pattern: "GitLab is not responding"
  failure_category: "gitlab_unavailable"
- pattern: "fatal: unable to access 'https://gitlab.com"
  failure_category: "gitlab_unavailable"
- pattern: "PG::ConnectionBad"
  failure_category: "postgresql_unavailable"
- pattern: "Downloading artifacts from coordinator... not found"
  failure_category: "artifacts_not_found_404"
- pattern: "curl: \\(7\\) Failed to connect to 127.0.0.1 port 3000 after"
  failure_category: "rails-production-server-boot"
- pattern: "curl: \\(7\\) Failed to connect to 127.0.0.1 port 8080 after"
  failure_category: "rails-production-server-boot"
- pattern: "Redis client could not fetch cluster information"
  failure_category: "redis"

# CNG
- pattern: "=== block '.+' error ==="
  failure_category: "cng"
- pattern: "failed to load command: orchestrator"
  failure_category: "cng"

# E2E container images build
- pattern: "Building GDK image"
  failure_category: "build_gdk_image"
- pattern: "Building QA image for"
  failure_category: "build_qa_image"

# RSpec (loosely related)
- pattern: "We have detected a PG::QueryCanceled error in the specs, so we're failing early."
  failure_category: "pg_query_canceled"

# Rake tasks
- pattern: "Feature::InvalidFeatureFlagError: "
  failure_category: "rake_invalid_feature_flag"
- pattern: "New version of Sprockets detected. This patch can likely be removed."
  failure_category: "rake_new_version_of_sprockets"
- pattern: "Don't know how to build task.+See the list of available tasks with"
  failure_category: "rake_task_not_found"
- pattern: "Changes in worker queues found, please update the metadata by running"
  failure_category: "rake_change_in_worker_queues"

# Other
- pattern: "Could not find downstream pipeline triggered via"
  failure_category: "e2e:code-suggestions-eval"
- pattern: "Feature flag usage check failed"
  failure_category: "feature_flag_usage_check_failure"
- pattern: "Job execution will continue but no more output will be collected"
  failure_category: "logs_too_big_to_analyze"
