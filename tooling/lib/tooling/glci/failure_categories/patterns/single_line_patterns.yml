# Important: The order of failure categories matter here. It's going to match from top to bottom.
failure_categories:
  danger:
    description: "Issues with the Danger code review bot that checks MRs for common problems. Often seen when the 'danger-review' job needs to be retried."
    patterns:
      - "If needed, you can retry the.+`danger-review` job"
  db_migrations:
    description: "Database migration failures, including schema inconsistencies, rollback issues, pending migrations, and column operation errors. These issues often occur when database changes aren't properly synchronized."
    patterns:
      - "Error: rollback of added migrations does not revert db/structure.sql to previous state, please investigate"
      - "the committed db/structure.sql does not match the one generated by running added migrations"
      - "the committed files in db/schema_migrations do not match those expected by the added migrations"
      - "You have.+pending migrations"
      - "Column operations, like dropping, renaming or primary key conversion"
      - "createdb: error:"
      - "Batched migration should be finalized only after at-least one required stop from queuing it"
  db_table_write_protected:
    description: "Attempts to write to database tables that are protected within the GitLab database schema, or unsupported cross-joins between database tables. This usually happens when code tries to modify tables it shouldn't have access to."
    patterns:
      - "Table.+is write protected within this Gitlab database"
      - "Unsupported cross-join across"
  db_cross_schema_access:
    description: "Unauthorized cross-schema database access attempts, which occur when code tries to access tables outside the allowed schemas for the current database connection."
    patterns:
      - "Gitlab::Database::QueryAnalyzers::GitlabSchemasValidateConnection::CrossSchemaAccessError"
  db_connection_in_rails_initializer:
    description: "Database connections being made during Rails initializers, which is discouraged as it can cause race conditions and other issues during application startup."
    patterns:
      - "raise_database_connection_made_error"
  rails_pg_not_in_database_dictionary:
    description: "Tables missing from the database dictionary, which maintains metadata about database tables. New or deleted tables must be properly registered in the dictionary."
    patterns:
      - "Any new or deleted tables must be added to the database dictionary"
  rails_pg_no_foreign_key:
    description: "Missing foreign key constraints in the database schema, which can lead to data integrity issues. This typically happens during migration rollbacks or schema changes."
    patterns:
      - "has no foreign key for"
  rails_pg_active_sql_transaction:
    description: "Postgres errors related to operations that cannot be performed inside a transaction block, such as creating indexes concurrently."
    patterns:
      - "PG::ActiveSqlTransaction"
  rails_pg_check_violation:
    description: "Violations of PostgreSQL check constraints on database tables, which prevent invalid data from being inserted."
    patterns:
      - "PG::CheckViolation"
  rails_pg_dependent_objects_still_exist:
    description: "Attempts to drop database objects that have dependencies, such as constraints or references from other tables."
    patterns:
      - "PG::DependentObjectsStillExist"
  rails_pg_duplicate_alias:
    description: "SQL query errors due to duplicate table aliases, typically occurring in complex queries with the same table name specified multiple times."
    patterns:
      - "PG::DuplicateAlias"
  rails_pg_duplicate_table:
    description: "Attempts to create tables that already exist in the database, usually during migration rollbacks that aren't properly checking for existing tables."
    patterns:
      - "PG::DuplicateTable"
  rails_pg_invalid_column_reference:
    description: "SQL syntax errors related to invalid column references, such as ordering by columns not in the select list in a DISTINCT query."
    patterns:
      - "PG::InvalidColumnReference"
  rails_pg_undefined_column:
    description: "References to columns that don't exist in database tables, typically occurring during schema changes or mismatched migrations."
    patterns:
      - "PG::UndefinedColumn"
  rails_pg_undefined_table:
    description: "References to tables that don't exist in the database, often seen during migration rollbacks or when tables are renamed/dropped."
    patterns:
      - "PG::UndefinedTable"
  rails_pg_sidekiq:
    description: "Sidekiq API routing errors in the database context, particularly related to unrouted Sidekiq Redis calls that should be inside a .via block."
    patterns:
      - "Gitlab::SidekiqSharding::Validator::UnroutedSidekiqApiError"
  psql_failed_command:
    description: "Failures when executing PostgreSQL commands directly through psql, often seen during schema loading or database initialization."
    patterns:
      - "psql:.+ERROR:"
  rake_unallowed_schemas_accessed:
    description: "Unauthorized access attempts to restricted database schemas during rake tasks, which can happen when code tries to access tables outside its allowed scope."
    patterns:
      - "Gitlab::Database::QueryAnalyzers::RestrictAllowedSchemas::DMLAccessDeniedError:"
  rake_enqueue_from_transaction:
    description: "Attempts to enqueue Sidekiq jobs from within database transactions, which can lead to race conditions if the job runs before the transaction is committed."
    patterns:
      - "Sidekiq::Job::EnqueueFromTransactionError"
  rake_db_unknown_schema:
    description: "References to undefined database schemas in rake tasks, usually when configuration files are missing schema definitions."
    patterns:
      - "Gitlab::Database::GitlabSchema::UnknownSchemaError"
  rake_rails_unknown_primary_key:
    description: "Missing primary key definitions in ActiveRecord models, which can cause issues with record identification and association management."
    patterns:
      - "ActiveRecord::UnknownPrimaryKey"
  error_in_db_migration:
    description: "General errors occurring during database migrations that cause the migration and all subsequent migrations to be canceled."
    patterns:
      - "An error has occurred, this and all later migrations canceled"
      - "An error has occurred, all later migrations canceled"
  rails_invalid_sql_statement:
    description: "Invalid SQL statements in Rails ActiveRecord operations that cannot be executed by PostgreSQL due to syntax or semantic errors."
    patterns:
      - "ActiveRecord::StatementInvalid"
  graphql_lint:
    description: "GraphQL schema validation and linting errors, including outdated schema files that need to be regenerated or queries that fail validation."
    patterns:
      - "needs to be regenerated, please run:"
      - "GraphQL quer.+out of.+failed validation:"
  eslint:
    description: "JavaScript code style and quality issues detected by ESLint, the JavaScript linter used in GitLab's frontend development."
    patterns:
      - "node scripts/frontend/eslint.js . --format gitlab"
      - "Running ESLint with the following rules enabled"
  docs_lint_failed:
    description: "Documentation linting failures, including formatting issues, broken links, and other quality checks for GitLab's documentation."
    patterns:
      - "ERROR: lint test\\(s\\) failed.+Review the log carefully to see full listing"
      - "files inspected,.+lints? detected"
      - "Issues found in .+input.+Find details below."
      - "scripts/lint-docs-redirects.rb"
      - "git diff --exit-code db/docs"
  docs_outdated:
    description: "Outdated documentation that needs to be regenerated, typically seen when code changes affect documented features or APIs."
    patterns:
      - "documentation is outdated.+Please update it by running"
  cells_lint:
    description: "Linting failures in Cells-related code and configuration, particularly around application settings definition files."
    patterns:
      - "scripts/cells/ci-ensure-application-settings-have-definition-file.rb"
  pajamas_violations:
    description: "Violations of Pajamas design system requirements, GitLab's design system that ensures consistent UI components and experiences."
    patterns:
      - "blocking Pajamas violation\\(s\\) found."
      - "Merge request scan exit status: 2"
  yaml_lint_failed:
    description: "YAML syntax and formatting issues detected by yamllint, which checks for problems in YAML configuration files."
    patterns:
      - "yamllint "
  rake_some_po_files_invalid:
    description: "Invalid translation files (PO files) detected during rake tasks, usually containing syntax errors or formatting issues."
    patterns:
      - "Not all PO-files are valid"
  rake_outdated_translated_strings:
    description: "Outdated translation strings that need to be updated to match changes in the source language strings."
    patterns:
      - "Changes in translated strings found, please update file"
  docs_deprecations_outdated:
    description: "Outdated documentation about deprecated features that needs to be updated to reflect current deprecation status."
    patterns:
      - "ERROR: Deprecations documentation is outdated"
  frontend_lockfile:
    description: "Issues with frontend dependency lockfiles, including Yarn lockfile inconsistencies that need to be resolved."
    patterns:
      - "Found problems with the lockfile"
      - "Your lockfile needs to be updated, but yarn was run with"
  yarn_dependency_violation:
    description: "Peer dependency violations in Yarn packages, where installed packages don't meet the version requirements of their dependents."
    patterns:
      - "Peer dependency violation"
  yarn_run:
    description: "Failures in Yarn script execution, typically in frontend build, test, or lint commands."
    patterns:
      - "yarn run.+failed with the following error"
  gemfile_issues:
    description: "Issues with Ruby gem dependencies and Gemfile lockfiles, including outdated dependencies, checksum mismatches, and conflicting gems."
    patterns:
      - "changed, but the lockfile can't be updated"
      - "Your lockfile does not satisfy dependencies of"
      - "contains outdated dependencies"
      - "You have already activated"
      - "but your Gemfile requires"
      - "\\(r-\\)generate Gemfile.checksum with"
      - "Bundler cannot continue installing"
      - "Cached checksum for .+ not found"
  gems_not_found:
    description: "Missing Ruby gems required by the application, which can happen when dependencies aren't properly installed or configured."
    patterns:
      - "Bundler::GemNotFound"
  gems_build:
    description: "Failures during gem native extension building, which often occur with gems that have C extensions that fail to compile."
    patterns:
      - "Gem::Ext::BuildError: ERROR: Failed to build gem native extension."
  bao_linux_checksum_mismatch:
    description: "Checksum verification failures for the bao-linux-amd64 binary, used for OpenBao secrets management in GitLab."
    patterns:
      - "ERROR: Checksum mismatch for `bao-linux-amd64`"
  gemnasium-python-dependency_scanning:
    description: "Failures in Python dependency scanning with Gemnasium, typically related to pipenv sync issues in dependency scanning jobs."
    patterns:
      - "running /usr/local/bin/pipenv sync .+: exit status 1"
      - "\\[gemnasium-python\\] .+ pipenv sync failed"
  dependency-scanning_permission_denied:
    description: "Permission issues during dependency scanning, where the scanner cannot access files due to insufficient permissions."
    patterns:
      - "\\[FATA\\] \\[dependency-scanning\\].+ permission denied"
  package_hunter:
    description: "Errors in package monitoring and tracking services, used to scan for vulnerabilities in project dependencies."
    patterns:
      - "Error calling /monitor/project/"
  git_issues:
    description: "Git repository and version control related failures, including cloning issues, reference problems, and connectivity errors."
    patterns:
      - "cloning repository: exit status 128"
      - "did not match any file\\(s\\) known to git"
      - "fatal: couldn't find remote ref"
      - "fatal: expected flush after ref listing"
      - "fatal: fetch-pack: invalid index-pack output"
      - "fatal: Not a valid object name"
      - "fatal: protocol error: bad pack header"
      - "fatal: the remote end hung up unexpectedly"
      - "TimeoutExpired: Command '\\['git', 'fetch'"
  as_if_foss_git_push_issues:
    description: "Git push failures in the as-if-FOSS pipeline, which creates a mirror of the GitLab codebase without EE-specific code."
    patterns:
      - "failed to push some refs to 'https://gitlab.com/gitlab-org/gitlab-foss.git'"
  rubocop:
    description: "Ruby code style and quality issues detected by RuboCop, the Ruby linter and static code analyzer used in GitLab's backend development."
    patterns:
      - "offenses? detected"
      - "=== Filtered warnings ==="
  jest:
    description: "JavaScript test failures in Jest test suites, used for testing GitLab's frontend code."
    patterns:
      - "Command .+ node_modules/.bin/jest.+ exited with status 1"
  rspec_undercoverage:
    description: "Insufficient test coverage detected in the codebase, where methods or classes lack adequate test coverage."
    patterns:
      - "some methods have no test coverage!"
  gitaly_spawn_failed:
    description: "Failures in spawning Gitaly service processes, which handle Git operations in GitLab."
    patterns:
      - "gitaly spawn failed"
  apollo:
    description: "Issues with Apollo GraphQL client configuration or operation, used for frontend GraphQL interactions."
    patterns:
      - "Loading Apollo Project"
  rspec_test_already_failed_on_default_branch:
    description: "Tests that are already failing on the default branch, indicated by exit code 112. These failures are not introduced by the current changes."
    patterns:
      - "ERROR: Job failed: exit code 112"
  assets_compilation:
    description: "Failures during frontend asset compilation with webpack, used to bundle JavaScript, CSS, and other assets."
    patterns:
      - "Error: Unable to compile webpack production bundle"
  webpack_cli:
    description: "Webpack CLI execution errors, typically related to file system operations during the build process."
    patterns:
      - "webpack-cli.+Error: EEXIST: file already exists"
  vuejs3:
    description: "Compatibility issues with Vue.js 3 migrations, as GitLab transitions from Vue 2 to Vue 3 in its frontend code."
    patterns:
      - "Expected unset environment variable"
      - "either now pass under Vue 3, or no longer exist"
  rspec_usage:
    description: "Improper usage of RSpec testing framework features, including issues with doubles, shared contexts, and other testing patterns."
    patterns:
      - "The use of doubles or partial doubles from rspec-mocks outside of the per-test lifecycle is not supported."
      - "Could not find shared context"
      - "Could not find shared examples"
      - "is not available on an example group"
      - "WebMock::NetConnectNotAllowedError"
  gitlab_too_much_load:
    description: "Situations where GitLab instance is under excessive load and unable to handle requests, typically seen in pipeline or API interactions."
    patterns:
      - "GitLab is currently unable to handle this request due to load."
  failed_to_pull_image:
    description: "Docker image pull failures in CI/CD, where container images cannot be downloaded from the registry."
    patterns:
      - "ERROR: Job failed: failed to pull image"
  docker_not_running:
    description: "Issues where the Docker daemon is not running or is unavailable, preventing container operations."
    patterns:
      - "Is the docker daemon running"
  no_space_left:
    description: "Insufficient disk space on the CI/CD runner, causing file operations to fail due to lack of storage."
    patterns:
      - "no space left on device"
      - "There was insufficient space remaining on the device"
  artifacts_upload_502:
    description: "Bad Gateway errors (HTTP 502) during CI/CD artifact uploads, typically due to network or server issues."
    patterns:
      - "Uploading artifacts .+ 502 Bad Gateway"
  http_500:
    description: "HTTP 500 Internal Server errors when interacting with web services, indicating server-side problems."
    patterns:
      - "500 Internal Server Error"
  kubernetes:
    description: "Kubernetes cluster connectivity or operation issues, affecting containerized deployments and tests."
    patterns:
      - "Error: Kubernetes cluster unreachable"
  http_502:
    description: "HTTP 502 Bad Gateway errors when interacting with web services, indicating proxy or intermediate server issues."
    patterns:
      - "502 Server Error"
      - "502 \"Bad Gateway\""
      - "status code: 502"
  gitlab_unavailable:
    description: "Situations where GitLab instance is unavailable or unresponsive, preventing API requests or Git operations."
    patterns:
      - "The requested URL returned error: 500"
      - "GitLab is not responding"
      - "fatal: unable to access 'https://gitlab.com"
  postgresql_unavailable:
    description: "PostgreSQL database connection failures, where the database is unreachable or returns connection errors."
    patterns:
      - "PG::ConnectionBad"
  artifacts_not_found_404:
    description: "CI/CD artifacts not found (HTTP 404 errors), typically when trying to download artifacts from previous jobs that don't exist."
    patterns:
      - "Downloading artifacts from coordinator... not found"
  rails-production-server-boot:
    description: "Rails production server boot failures, where the application server fails to start or respond to requests on expected ports."
    patterns:
      - "curl: \\(7\\) Failed to connect to 127.0.0.1 port 3000 after"
      - "curl: \\(7\\) Failed to connect to 127.0.0.1 port 8080 after"
  redis:
    description: "Redis connection or operation issues, affecting caching, queuing, and other Redis-dependent services."
    patterns:
      - "Redis client could not fetch cluster information"
  cng:
    description: "Cloud Native GitLab container image issues, affecting containerized GitLab deployments and related tools."
    patterns:
      - "=== block '.+' error ==="
      - "failed to load command: orchestrator"
  build_gdk_image:
    description: "Failures during GitLab Development Kit image building, used for local development environments."
    patterns:
      - "Building GDK image"
  build_qa_image:
    description: "Failures during QA image building, used for end-to-end testing of GitLab."
    patterns:
      - "Building QA image for"
  pg_query_canceled:
    description: "PostgreSQL query cancellation errors in tests, typically due to long-running queries or timeout configurations."
    patterns:
      - "We have detected a PG::QueryCanceled error in the specs, so we're failing early."
  rake_invalid_feature_flag:
    description: "Invalid feature flag configurations detected, such as improper default settings or missing definition files."
    patterns:
      - "Feature::InvalidFeatureFlagError: "
  rake_new_version_of_sprockets:
    description: "Outdated Sprockets asset pipeline patching that is no longer needed with newer versions of Sprockets."
    patterns:
      - "New version of Sprockets detected. This patch can likely be removed."
  rake_task_not_found:
    description: "Referenced rake tasks that don't exist, typically due to typos or removed tasks."
    patterns:
      - "Don't know how to build task.+See the list of available tasks with"
  rake_change_in_worker_queues:
    description: "Changes detected in Sidekiq worker queue configurations that require metadata updates."
    patterns:
      - "Changes in worker queues found, please update the metadata by running"
  e2e:code-suggestions-eval:
    description: "End-to-end test failures in code suggestions evaluation, particularly when downstream pipelines can't be found."
    patterns:
      - "Could not find downstream pipeline triggered via"
  feature_flag_usage_check_failure:
    description: "Feature flag usage check failures, where feature flags are not properly defined or used."
    patterns:
      - "Feature flag usage check failed"
  logs_too_big_to_analyze:
    description: "Log output exceeded size limits for complete analysis, truncating job logs and potentially hiding important information."
    patterns:
      - "Job execution will continue but no more output will be collected"
